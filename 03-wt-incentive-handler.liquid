{% comment %}
  ============================================================
  WeTwo ‚Äî Incentive Handler
  Snippet: wt-incentive-handler.liquid
  Version: 1.0 ‚Äî February 13, 2026
  
  PURPOSE:
  Handles the two visitor paths:
  1. Registry brides: arrives via &cb=X cashback link ‚Üí shows cashback banner
  2. Shoppers: enters coupon code at checkout (standard Shopify) ‚Üí no special handling needed
  
  This snippet handles PATH 1 ‚Äî the cashback parameter.
  Path 2 (coupons) is handled natively by Shopify discount codes.
  
  PLACEMENT:
  Add {% render 'wt-incentive-handler' %} in theme.liquid after the branding engine script.
  
  DEPENDENCIES:
  - window.wtVendor (set by branding engine)
  - window.wtVendorReady (Promise from branding engine)
  - &cb= URL parameter
  ============================================================
{% endcomment %}

<style id="wt-incentive-styles">
  /* ---- Cashback Banner ---- */
  .wt-cashback-bar {
    background: linear-gradient(135deg, #f9f5f0, #fdf8f3);
    border-bottom: 1px solid #e8ddd0;
    padding: 10px 20px;
    text-align: center;
    font-family: 'Montserrat', -apple-system, sans-serif;
    font-size: 13px;
    color: #4a4a4a;
    position: relative;
    z-index: 90;
    display: none; /* shown by JS when cb param present */
  }
  
  .wt-cashback-bar.is-visible {
    display: block;
  }
  
  .wt-cashback-bar__amount {
    font-weight: 700;
    color: var(--colorBtnPrimary, #c4956a);
  }
  
  .wt-cashback-bar__vendor {
    font-weight: 600;
    color: #1a1a1a;
  }
  
  .wt-cashback-bar__cta {
    display: inline-block;
    margin-left: 12px;
    padding: 4px 14px;
    background: var(--colorBtnPrimary, #c4956a);
    color: #ffffff;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-decoration: none;
    transition: opacity 0.2s;
  }
  
  .wt-cashback-bar__cta:hover {
    opacity: 0.9;
  }

  /* ---- Registry vs Shop Split Buttons ---- */
  .wt-path-buttons {
    display: none; /* shown by JS for vendor stores */
    justify-content: center;
    gap: 16px;
    padding: 24px 20px;
    background: #ffffff;
  }

  .wt-path-buttons.is-visible {
    display: flex;
  }

  .wt-path-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 28px;
    border-radius: 8px;
    font-family: 'Montserrat', -apple-system, sans-serif;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .wt-path-btn--registry {
    background: var(--colorBtnPrimary, #c4956a);
    color: #ffffff;
    border: 2px solid var(--colorBtnPrimary, #c4956a);
  }

  .wt-path-btn--registry:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }

  .wt-path-btn--shop {
    background: #ffffff;
    color: var(--colorBtnPrimary, #1a1a1a);
    border: 2px solid var(--colorBtnPrimary, #1a1a1a);
  }

  .wt-path-btn--shop:hover {
    background: var(--colorBtnPrimary, #1a1a1a);
    color: #ffffff;
    transform: translateY(-1px);
  }

  .wt-path-btn svg {
    flex-shrink: 0;
  }

  @media (max-width: 599px) {
    .wt-path-buttons {
      flex-direction: column;
      padding: 20px 16px;
      gap: 10px;
    }
    .wt-path-btn {
      justify-content: center;
      padding: 14px 24px;
    }
    .wt-cashback-bar {
      font-size: 12px;
      padding: 8px 12px;
    }
    .wt-cashback-bar__cta {
      display: block;
      margin: 8px auto 0;
      width: fit-content;
    }
  }
</style>

<!-- Cashback banner (hidden, shown by JS) -->
<div id="wt-cashback-bar" class="wt-cashback-bar" aria-live="polite"></div>

<!-- Registry / Shop path buttons (hidden, shown by JS for vendor stores) -->
<div id="wt-path-buttons" class="wt-path-buttons"></div>

<script>
(function() {
  'use strict';

  // ================================================
  // WeTwo Incentive Handler
  // ================================================

  const STORE_URL = 'https://wetwo.love';
  const REGISTRY_FORM_PATH = '/pages/create-registry';  // adjust to actual path
  const SHOP_PATH = '/collections/all';                   // adjust to actual path

  // ---- Read URL params ----
  const params = new URLSearchParams(window.location.search);
  const cbParam = params.get('cb');    // cashback percentage from link
  const refParam = params.get('ref');  // vendor ref

  // ---- Store cashback tier in session ----
  if (cbParam) {
    const cbPct = parseInt(cbParam, 10);
    if ([5, 10, 15, 20, 25].includes(cbPct)) {
      sessionStorage.setItem('wt_cashback_pct', cbPct.toString());
      sessionStorage.setItem('wt_cashback_ref', refParam || '');
    }
  }

  // Retrieve from session (persists across page navigations)
  const activeCashback = parseInt(sessionStorage.getItem('wt_cashback_pct') || '0', 10);
  const activeRef = sessionStorage.getItem('wt_cashback_ref') || refParam || '';

  // ---- Show cashback banner if active ----
  function showCashbackBanner(vendorName) {
    if (activeCashback <= 0) return;

    const bar = document.getElementById('wt-cashback-bar');
    if (!bar) return;

    bar.innerHTML = `
      <span>üéÅ You're getting <span class="wt-cashback-bar__amount">${activeCashback}% cashback</span> 
      on your registry gifts${vendorName ? ', courtesy of <span class="wt-cashback-bar__vendor">' + vendorName + '</span>' : ''}!</span>
      <a href="${REGISTRY_FORM_PATH}${activeRef ? '?ref=' + encodeURIComponent(activeRef) : ''}" 
         class="wt-cashback-bar__cta">Create Registry</a>
    `;
    bar.classList.add('is-visible');

    // Position after header
    const header = document.querySelector('.shopify-section-header, header');
    if (header && bar.parentNode !== header.parentNode) {
      header.after(bar);
    }
  }

  // ---- Show Registry / Shop path buttons ----
  function showPathButtons(vendorSlug) {
    const container = document.getElementById('wt-path-buttons');
    if (!container) return;

    const refStr = vendorSlug ? `?ref=${encodeURIComponent(vendorSlug)}` : '';

    container.innerHTML = `
      <a href="${REGISTRY_FORM_PATH}${refStr}" class="wt-path-btn wt-path-btn--registry">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
        </svg>
        Create Your Registry
      </a>
      <a href="${SHOP_PATH}${refStr}" class="wt-path-btn wt-path-btn--shop">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
          <line x1="3" y1="6" x2="21" y2="6"/>
          <path d="M16 10a4 4 0 01-8 0"/>
        </svg>
        Shop & Save
      </a>
    `;
    container.classList.add('is-visible');

    // Position after the collage section (or after header if no collage)
    const collage = document.querySelector('.sliding-banner-collage, [data-section-type="sliding-banner-collage"]');
    const header = document.querySelector('.shopify-section-header, header');
    const insertAfter = collage || header;
    
    if (insertAfter && container.parentNode !== insertAfter.parentNode) {
      insertAfter.after(container);
    }
  }

  // ---- Add path buttons to drawer menu ----
  function addPathsToDrawer(vendorSlug) {
    const drawer = document.querySelector('.wt-drawer-menu, .drawer-menu-clean');
    if (!drawer) return;

    const refStr = vendorSlug ? `?ref=${encodeURIComponent(vendorSlug)}` : '';

    const pathSection = document.createElement('div');
    pathSection.className = 'wt-drawer-paths';
    pathSection.style.cssText = 'padding: 16px 20px; border-top: 1px solid #e8e8e8; display: flex; flex-direction: column; gap: 10px;';

    pathSection.innerHTML = `
      <a href="${REGISTRY_FORM_PATH}${refStr}" 
         style="display:flex;align-items:center;gap:8px;padding:12px 16px;background:var(--colorBtnPrimary, #c4956a);color:#fff;border-radius:6px;font-family:'Montserrat',sans-serif;font-size:13px;font-weight:600;letter-spacing:0.04em;text-transform:uppercase;text-decoration:none;justify-content:center;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
        Create Registry
      </a>
      <a href="${SHOP_PATH}${refStr}" 
         style="display:flex;align-items:center;gap:8px;padding:12px 16px;background:#fff;color:var(--colorBtnPrimary, #1a1a1a);border:2px solid var(--colorBtnPrimary, #1a1a1a);border-radius:6px;font-family:'Montserrat',sans-serif;font-size:13px;font-weight:600;letter-spacing:0.04em;text-transform:uppercase;text-decoration:none;justify-content:center;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>
        Shop & Save
      </a>
    `;

    // Insert after the nav links but before the close area
    const navLinks = drawer.querySelector('.drawer-nav, .wt-drawer-nav, ul');
    if (navLinks) {
      navLinks.after(pathSection);
    } else {
      drawer.appendChild(pathSection);
    }
  }

  // ---- Track cashback for cart/checkout ----
  // Stores the active cashback % so it can be applied post-purchase
  function trackCashbackForCheckout() {
    if (activeCashback <= 0) return;

    // Store in a cart attribute via Shopify AJAX API
    fetch('/cart/update.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        attributes: {
          'wt_cashback_pct': activeCashback.toString(),
          'wt_vendor_ref': activeRef,
          'wt_cashback_applied': 'true'
        }
      })
    }).catch(err => console.warn('[WeTwo] Could not set cart attributes:', err));
  }

  // ---- Initialize ----
  function init() {
    // Wait for vendor data if available
    if (window.wtVendorReady) {
      window.wtVendorReady.then(function(vendorData) {
        const vendorName = vendorData ? 
          (vendorData.white_label_name || vendorData.business_name) : null;
        const vendorSlug = vendorData ? vendorData.referral_slug : null;
        const fullRef = refParam || (vendorSlug ? 'vendor-' + vendorSlug : '');

        // Show cashback banner if cb param is active
        showCashbackBanner(vendorName);

        // Show path buttons for vendor stores
        if (vendorData && (vendorData.has_branded_store || fullRef)) {
          showPathButtons(fullRef);
          addPathsToDrawer(fullRef);
        }

        // Track cashback in cart
        trackCashbackForCheckout();
      });
    } else {
      // No branding engine ‚Äî still handle cb param
      if (activeCashback > 0) {
        showCashbackBanner(null);
        trackCashbackForCheckout();
      }
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
